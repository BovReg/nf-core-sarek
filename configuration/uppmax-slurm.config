/*
vim: syntax=groovy
-*- mode: groovy;-*-
 * -------------------------------------------------
 * Nextflow config file for CAW project
 * -------------------------------------------------
 * Slurm configuration for UPPMAX clusters
 * -------------------------------------------------
 */

params {
  runTime       = 48.h
  singleCPUMem  = 7.GB // for processes that are using more memory but a single CPU only. Use the 'core' queue for these
}

process {
  clusterOptions = {"-A $params.project"}
  cpus = 16
  executor = 'slurm'
  memory = 110.GB
  queue = 'node'
  time = 48.h

  // specific queue for specific processes
  $ConcatVCF.queue                = 'core'
  $CreateRecalibrationTable.queue = 'core'
  $IndelRealigner.queue           = 'core'
  $MarkDuplicates.queue           = 'core'
  $MergeBams.queue                = 'core'
  $RecalibrateBam.queue           = 'core'
  $RunAlleleCount.queue           = 'core'
  $RunAscat.queue                 = 'core'
  $RunConvertAlleleCounts.queue   = 'core'
  $RunFreeBayes.queue             = 'core'
  $RunHaplotypecaller.queue       = 'core'
  $RunMutect1.queue               = 'core'
  $RunMutect2.queue               = 'core'

  errorStrategy = {task.exitStatus == 143 ? 'retry' : 'terminate'}
  maxErrors = '-1'
  maxRetries = 3

  $BuildBWAindexes {
  }
  $BuildPicardIndex {
  }
  $BuildSAMToolsIndex {
  }
  $BuildVCFIndex {
  }
  $ConcatVCF {
  }
  $CreateRecalibrationTable {
    time = {params.runTime * task.attempt}
    cpus = 10
    memory = {checkMaxMemory(params.singleCPUMem * 8 * task.attempt)}
  }
  $IndelRealigner {
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {checkMaxMemory(params.singleCPUMem * task.attempt)}
  }
  $MapReads {
    time = {params.runTime * task.attempt}
  }
  $MarkDuplicates {
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {checkMaxMemory(params.singleCPUMem * 8 * task.attempt)}
  }
  $MergeBams {
    time = {params.runTime * task.attempt}
    memory = {checkMaxMemory(params.singleCPUMem * task.attempt)}
  }
  $RealignerTargetCreator {
    time = {params.runTime * task.attempt}
  }
  $RecalibrateBam {
    time = {params.runTime * task.attempt}
    cpus = 8
    memory = {checkMaxMemory(params.singleCPUMem * 8 * task.attempt)}
  }
  $RunAlleleCount {
    cpus = 1
    memory = {checkMaxMemory(params.singleCPUMem * 2 * task.attempt)}
  }
  $RunAscat {
    cpus = 1
    memory = {checkMaxMemory(params.singleCPUMem * 2 * task.attempt)}
  }
  $RunBamQC {
  }
  $RunBcftoolsStats {
    cpus = 1
  }
  $RunConvertAlleleCounts {
    cpus = 1
    memory = {checkMaxMemory(params.singleCPUMem * 2 * task.attempt)}
  }
  $RunFastQC {
    errorStrategy = { task.exitStatus == 143 ? 'retry' : 'ignore' }
  }
  $RunFreeBayes {
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {params.singleCPUMem * task.attempt}
  }
  $RunHaplotypecaller {
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {checkMaxMemory(params.singleCPUMem * task.attempt * task.attempt)} // this way the memory will increase quadratically as 8G, 32G, 72G
  }
  $RunGenotypeGVCFs {
    cpus = 1
    memory = {params.singleCPUMem}
  }
  $RunManta {
  }
  $RunMultiQC {
    errorStrategy = { task.exitStatus == 143 ? 'retry' : 'ignore' }
  }
  $RunMutect1 {
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {checkMaxMemory(params.singleCPUMem * task.attempt)}
  }
  $RunMutect2 {
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {checkMaxMemory(params.singleCPUMem * task.attempt)}
  }
  $RunSamtoolsStats {
    time = {params.runTime * task.attempt}
    cpus = 1
  }
  $RunSnpeff {
    errorStrategy = { task.exitStatus == 143 ? 'retry' : 'ignore' }
  }
  $RunStrelka {
    time = {params.runTime * task.attempt}
  }
  $RunVEP {
    cpus = 1
    errorStrategy = { task.exitStatus == 143 ? 'retry' : 'ignore' }
  }
}
