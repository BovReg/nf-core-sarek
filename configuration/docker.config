/*
vim: syntax=groovy
-*- mode: groovy;-*-
 * -------------------------------------------------
 * Nextflow config file for CAW project
 * working on milou (UPPMAX)
 * -------------------------------------------------
 * Should be saved either within CAW installation
 * as nextflow.config, or with Nextflow installation
 * as $NXF_HOME/config
 */

env {
  NXF_OPTS="-Xms1g -Xmx4g"
}

params {
  runTime       = 48.h
  singleCPUMem  = 8.GB // for processes that are using more memory but a single CPU only. Use the 'core' queue for these
}

docker {
  enabled = true
}

process {
  errorStrategy = {task.exitStatus == 143 ? 'retry' : 'terminate'}
  maxRetries = 3
  maxErrors = '-1'

  $RunFastQC {
    container = 'maxulysse/fastqc:0.11.5'
    errorStrategy = { task.exitStatus == 143 ? 'retry' : 'ignore' }
  }
  $MapReads {
    container = 'maxulysse/mapreads:0.9.9'
    time = {params.runTime * task.attempt}
  }
  $MergeBams {
    container = 'maxulysse/samtools:1.3'
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {params.singleCPUMem * task.attempt}
  }
  $MarkDuplicates {
    container = 'maxulysse/picard:1.118'
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {params.singleCPUMem * 8 * task.attempt}
  }
  $CreateIntervals {
    container = 'maxulysse/gatk:3.6'
    time = {params.runTime * task.attempt}
  }
  $RealignBams {
    container = 'maxulysse/gatk:3.6'
    time = {params.runTime * task.attempt}
  }
  $CreateRecalibrationTable {
    container = 'maxulysse/gatk:3.6'
    time = {params.runTime * task.attempt}
  }
  $RecalibrateBam {
    container = 'maxulysse/gatk:3.6'
    time = {params.runTime * task.attempt}
  }
  $RunHaplotypecaller {
    container = 'maxulysse/gatk:3.6'
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {params.singleCPUMem * 8 *task.attempt}
  }
  $RunMutect1 {
    container = 'maxulysse/mutect1:1.5'
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {params.singleCPUMem * 2 * task.attempt}
  }
  $RunMutect2 {
    container = 'maxulysse/gatk:3.6'
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {params.singleCPUMem * 2 * task.attempt}
  }
  $RunFreeBayes {
    module = ['bioinfo-tools', 'java/sun_jdk1.8.0_40', 'freebayes/1.0.2']
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {params.singleCPUMem * 4 * task.attempt}
  }
  $RunVardict {
    module = ['bioinfo-tools', 'java/sun_jdk1.8.0_40', 'R/3.2.3', 'gcc/4.9.2', 'perl/5.18.4']
    time = {params.runTime * task.attempt}
    cpus = 1
    memory = {params.singleCPUMem * 4 * task.attempt}
  }
  $ConcatVCF {
    container = 'maxulysse/gatk:3.6'
  }
  $RunStrelka {
    module = ['bioinfo-tools']
    time = {params.runTime * task.attempt}
  }
  $RunManta {
    module = ['bioinfo-tools', 'samtools/1.3', 'manta/1.0.0']
  }
  $RunAlleleCount {
    module = ['bioinfo-tools', 'alleleCount']
    cpus = 1
    memory = {params.singleCPUMem * 2 * task.attempt}
  }
  $RunConvertAlleleCounts {
    cpus = 1
    memory = {params.singleCPUMem * 2 * task.attempt}
  }
  $RunAscat {
    module = ['R/3.2.3']
    cpus = 1
    memory = {params.singleCPUMem * 2 * task.attempt}
  }
  $RunMultiQC {
    module = ['bioinfo-tools', 'MultiQC/0.9']
    errorStrategy = { task.exitStatus == 143 ? 'retry' : 'ignore' }
  }
}
